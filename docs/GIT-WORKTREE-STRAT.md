# Git Worktrees Integration with APDevFlow

## Overview

Git worktrees enable developers to work on multiple JIRA tickets simultaneously without constant branch switching or stashing. This guide shows how to integrate git worktrees seamlessly with the APDevFlow workflow.

**Product:** APDevFlow (Agile Programming DevFlow)  
**CLI:** `devflow` (primary) + `apdev` (alias)  
**Created by:** Aaron Prill, AP Dev Solutions

---

## What Are Git Worktrees?

Git worktrees let you check out multiple branches simultaneously in different directories, all sharing the same repository history.

**Traditional Git:**
```bash
# Working on PROJ-123
$ git checkout feature/PROJ-123
# Edit files...

# Oh no, urgent bug! Need to switch...
$ git stash                    # Save current work
$ git checkout main
$ git checkout -b hotfix/PROJ-124
# Fix bug, commit, merge...

$ git checkout feature/PROJ-123
$ git stash pop                # Resume previous work
```

**With Git Worktrees:**
```bash
# Multiple branches, checked out simultaneously
~/repos/myapp/              # Main worktree (main branch)
~/repos/myapp-PROJ-123/     # Worktree for PROJ-123
~/repos/myapp-PROJ-124/     # Worktree for PROJ-124

# Switch is just: cd ~/repos/myapp-PROJ-124
# No stashing, no checkout, instant context switch
```

---

## Why Worktrees + JIRA Bridge?

### Perfect Match

1. **One worktree per JIRA ticket** - Physical separation of work contexts
2. **JIRA exports live in worktree** - ticket.md, spec.md, implementation all together
3. **Claude skills execute in ticket context** - All files in one place
4. **No accidental cross-contamination** - Changes to PROJ-123 can't affect PROJ-124
5. **Parallel development** - Work on multiple stories simultaneously

### Developer Experience

**Before (traditional git):**
```
Developer's mental model: "Where did I put that change? Which branch am I on?"
Time wasted: ~15 minutes/day context switching
Risk: Committing to wrong branch, losing work
```

**After (worktrees):**
```
Developer's mental model: "Each ticket is a folder"
Time wasted: 0 minutes (just cd to the right folder)
Risk: None - physical isolation prevents mistakes
```

---

## Integrated Workflow

### Automatic Worktree Creation

When exporting a JIRA ticket, automatically create a git worktree for it:

```bash
# Developer clicks "Export & Setup Workspace" for PROJ-123
# Behind the scenes:

$ devflow export PROJ-123 --setup-worktree

# This does:
1. Creates git worktree at ~/repos/myapp-PROJ-123/
2. Creates branch feature/PROJ-123
3. Exports JIRA content to worktree root:
   ~/repos/myapp-PROJ-123/
     .jira/
       ticket.md
       context.md
       config.json
4. Opens VS Code in that worktree
5. Ready to work!
```

### Directory Structure

**Proposed Layout:**

```
~/repos/
  myapp/                          # Main repository (main branch)
    .git/                         # Git internals
    src/
    package.json
    
  myapp-PROJ-123/                 # Worktree for PROJ-123
    .jira/                        # JIRA export (not committed)
      ticket.md
      context.md
      spec.md                     # Generated by dev-spec
      config.json
    src/                          # Code (same as main, but on feature branch)
    package.json
    
  myapp-PROJ-124/                 # Worktree for PROJ-124
    .jira/
      ticket.md
      spec.md
    src/
    package.json
```

**Key Points:**
- `.jira/` directory holds all JIRA-related files
- `.jira/` is gitignored (not committed to repo)
- Source code changes are committed normally
- Each worktree is on its own feature branch

### Complete Developer Workflow

**Starting a New Story:**

```bash
# 1. From dashboard, click "Start Work on PROJ-123"
#    Backend API call creates worktree + exports ticket

$ devflow start PROJ-123

# Output:
✓ Created worktree: ~/repos/myapp-PROJ-123
✓ Created branch: feature/PROJ-123
✓ Exported JIRA ticket to .jira/
✓ Opened in VS Code

# 2. Developer navigates to worktree
$ cd ~/repos/myapp-PROJ-123

# 3. Generate spec
$ claude-code
> Read the story in .jira/ticket.md and use dev-spec to create a spec

# Claude creates .jira/spec.md

# 4. Implement
> Now use dev-execute to implement the spec in .jira/spec.md

# Claude creates implementation in src/

# 5. Test
$ npm test

# 6. Commit (using git-commit-helper skill)
$ git diff | claude-code "Generate commit message for this diff"
# Claude suggests: "feat(auth): implement JWT-based authentication"

$ git add .
$ git commit -m "feat(auth): implement JWT-based authentication"

# 7. Push
$ git push origin feature/PROJ-123

# 8. Upload artifacts to dashboard
$ devflow upload .jira/spec.md --attach

# 9. Create PR (manual or via CLI extension)
$ gh pr create --title "PROJ-123: Add user authentication"
```

**Working on Multiple Stories:**

```bash
# Morning standup - assigned 3 stories
$ jira-bridge start PROJ-123 PROJ-124 PROJ-125

# Creates 3 worktrees:
~/repos/myapp-PROJ-123/  (feature/PROJ-123)
~/repos/myapp-PROJ-124/  (feature/PROJ-124)
~/repos/myapp-PROJ-125/  (feature/PROJ-125)

# Work on PROJ-123 until blocked
$ cd ~/repos/myapp-PROJ-123
$ # ... work ...

# Blocked! Switch to PROJ-124 (instant, no stashing)
$ cd ~/repos/myapp-PROJ-124
$ # ... work ...

# Quick hotfix needed on PROJ-125
$ cd ~/repos/myapp-PROJ-125
$ # ... work ...

# Back to PROJ-123 (everything exactly as you left it)
$ cd ~/repos/myapp-PROJ-123
$ # ... continue work ...
```

---

## CLI Tool Enhancements

### Core Commands

**`devflow start <ticket-id>`**
```bash
$ devflow start PROJ-123

Actions:
1. Fetch ticket from JIRA
2. Determine repo root (look for .git/)
3. Create worktree: git worktree add ../myapp-PROJ-123 -b feature/PROJ-123
4. Export JIRA files to worktree/.jira/
5. Add .jira/ to .git/info/exclude (local gitignore)
6. Open in VS Code (code ../myapp-PROJ-123)

Options:
  --base <branch>        Base branch (default: main)
  --path <directory>     Custom worktree path
  --no-open              Don't open in VS Code
```

**`devflow finish <ticket-id>`**
```bash
$ devflow finish PROJ-123

Actions:
1. Prompt for final commit if uncommitted changes
2. Upload artifacts (.jira/spec.md) to dashboard
3. Create PR (if --create-pr flag)
4. Move JIRA ticket to "In Review"
5. Remove worktree (after confirmation)

Options:
  --keep-worktree        Don't remove worktree
  --create-pr            Auto-create pull request
  --no-upload            Don't upload artifacts
```

**`devflow list`**
```bash
$ devflow list

Active Worktrees:
┌────────────┬──────────────────────────────┬─────────────┬──────────┐
│ Ticket     │ Branch                        │ Status      │ Location │
├────────────┼──────────────────────────────┼─────────────┼──────────┤
│ PROJ-123   │ feature/PROJ-123              │ In Progress │ ~/repos/ │
│ PROJ-124   │ feature/PROJ-124              │ Blocked     │ ~/repos/ │
│ PROJ-125   │ hotfix/PROJ-125               │ In Review   │ ~/repos/ │
└────────────┴──────────────────────────────┴─────────────┴──────────┘

Options:
  --all         Include completed tickets
  --sync        Sync status with JIRA
```

**`devflow switch <ticket-id>`**
```bash
$ devflow switch PROJ-124

# Smarter than just 'cd':
# 1. Checks if worktree exists
# 2. If not, offers to create it
# 3. Opens in VS Code in new window
# 4. Shows ticket summary

Switching to PROJ-124: Fix login bug
Worktree: ~/repos/myapp-PROJ-124
Status: In Progress
Assignee: You

[Opened in VS Code]
```

**`devflow sync <ticket-id>`**
```bash
$ devflow sync PROJ-123

Actions:
1. Fetch latest ticket data from JIRA
2. Update .jira/ticket.md with changes
3. Show diff of what changed
4. Optionally re-run dev-spec if acceptance criteria changed

Changes detected:
  - Acceptance criteria updated
  - 1 new comment added
  - Story points changed: 5 → 8

Re-generate spec? [y/N]
```

**`devflow clean`**
```bash
$ devflow clean

# Remove worktrees for completed/merged tickets

Checking for completed tickets...

Safe to remove:
  - PROJ-120 (merged 7 days ago)
  - PROJ-121 (merged 3 days ago)

Remove 2 worktrees? [y/N]
```

---

## Enhanced Workflow Examples

### Example 1: Full Story Implementation

```bash
# Morning: Start on new story
$ devflow start PROJ-123
✓ Created worktree: ~/repos/myapp-PROJ-123
✓ Branch: feature/PROJ-123 (based on main)
✓ Exported ticket to .jira/
✓ Opened in VS Code

# Navigate to worktree (already there from auto-open)
$ pwd
~/repos/myapp-PROJ-123

# Review story
$ cat .jira/ticket.md
# User Story: Add user authentication
...

# Generate spec
$ claude-code
> Please read .jira/ticket.md and use the dev-spec skill to create 
  an implementation specification in .jira/spec.md

[Claude generates spec]

# Review spec
$ cat .jira/spec.md
# Implementation Specification: User Authentication
...

# Implement
$ claude-code
> Use dev-execute to implement the spec in .jira/spec.md

[Claude creates implementation files in src/auth/]

# Run tests
$ npm test
✓ All tests passing

# Commit with AI-generated message
$ git add .
$ git diff --cached | claude-code "Generate conventional commit message"
# Output: feat(auth): implement JWT-based authentication with bcrypt

$ git commit -m "feat(auth): implement JWT-based authentication with bcrypt"

# Push
$ git push origin feature/PROJ-123

# Upload spec to JIRA
$ devflow upload .jira/spec.md --attach

# Create PR
$ gh pr create \
  --title "PROJ-123: Add user authentication" \
  --body "$(cat .jira/spec.md)"

# Mark ticket as done
$ devflow finish PROJ-123 --keep-worktree
✓ Uploaded artifacts
✓ Moved ticket to "In Review"
✓ Worktree preserved (use --no-keep to remove)
```

### Example 2: Parallel Development

```bash
# Assigned 3 stories
$ devflow start PROJ-123 PROJ-124 PROJ-125
✓ Created 3 worktrees

# Work on first story
$ cd ~/repos/myapp-PROJ-123
$ # ... implement login feature ...
$ git commit -m "feat(auth): add login"

# Blocked on design review, switch to second story
$ cd ~/repos/myapp-PROJ-124
$ # ... implement dashboard ...
$ git commit -m "feat(dashboard): add metrics"

# Urgent bug! Switch to third story
$ cd ~/repos/myapp-PROJ-125
$ # ... fix bug ...
$ git commit -m "fix(api): handle null responses"
$ git push origin feature/PROJ-125

# PR merged quickly, clean up
$ devflow finish PROJ-125
✓ Removed worktree

# Back to first story (design approved)
$ cd ~/repos/myapp-PROJ-123
$ # ... continue exactly where I left off ...
```

### Example 3: Long-Running Feature Branch

```bash
# Start epic spanning multiple sprints
$ devflow start EPIC-10 --base main
✓ Created worktree for epic

# Work on epic, creating multiple commits
$ cd ~/repos/myapp-EPIC-10
$ # ... work ...

# Meanwhile, main branch is advancing
# Periodically sync epic branch with main
$ git fetch origin
$ git rebase origin/main

# Continue work across sprints
$ # ... more commits ...

# Epic complete after 3 weeks
$ devflow finish EPIC-10
```

---

## Integration with Claude Skills

### Directory Convention

All Claude skills should be aware of the `.jira/` directory:

**dev-spec skill adaptation:**
```markdown
# dev-spec/SKILL.md

## Instructions

If a `.jira/` directory exists:
  1. Read the story from `.jira/ticket.md`
  2. Read additional context from `.jira/context.md`
  3. Write the specification to `.jira/spec.md`

Otherwise (fallback):
  1. Look for `ticket.md` in current directory
  2. Write spec to `spec.md` in current directory
```

**dev-execute skill adaptation:**
```markdown
# dev-execute/SKILL.md

## Instructions

1. Read specification from `.jira/spec.md`
2. Create implementation files in appropriate `src/` directories
3. Do NOT create files in `.jira/` (that's for artifacts only)
```

### Skill Invocation Pattern

**In worktree root:**
```bash
# All skills automatically find .jira/ directory
$ claude-code
> Use dev-spec on the ticket
# Reads .jira/ticket.md, writes .jira/spec.md

> Use dev-execute on the spec
# Reads .jira/spec.md, writes to src/

> Use git-commit-helper for my staged changes
# Reads git diff, generates commit message
```

---

## Configuration

### Global Config

**`~/.apdevflow/config.json`:**
```json
{
  "worktrees": {
    "enabled": true,
    "baseDir": "~/repos",
    "namingPattern": "{repo}-{ticket}",
    "baseBranch": "main",
    "branchPattern": "feature/{ticket}",
    "autoOpen": true,
    "editor": "code",
    "cleanupDays": 30
  },
  "jiraExport": {
    "directory": ".jira",
    "files": ["ticket.md", "context.md", "config.json"]
  },
  "git": {
    "autoCommit": false,
    "commitTemplate": "feat({scope}): {summary}",
    "requireTests": true
  }
}
```

### Per-Project Config

**`.apdevflow.yml` in repo root:**
```yaml
worktree:
  base_branch: develop  # Use develop instead of main
  cleanup_after_merge: true
  
jira_export:
  include_comments: true
  include_attachments: false
  
skills:
  dev_spec:
    auto_invoke: false  # Don't auto-run
  dev_execute:
    auto_invoke: false
```

---

## Advanced Features

### Smart Cleanup

**Automatic cleanup of merged worktrees:**
```bash
# Cron job or manual invocation
$ devflow clean --auto

Scanning for merged branches...

Safe to remove (merged to main):
  ✓ PROJ-118 (merged 14 days ago)
  ✓ PROJ-119 (merged 10 days ago)
  ✓ PROJ-120 (merged 3 days ago)

Removed 3 worktrees, freed 450 MB
```

### Worktree Templates

**Create worktree with pre-configured setup:**
```bash
$ devflow start PROJ-123 --template backend-service

Actions:
1. Create worktree
2. Copy .apdevflow/templates/backend-service/ contents
3. Run template setup script
4. Install dependencies (npm install)
5. Ready to code

Template applied: backend-service
  - Created src/services/
  - Created tests/unit/
  - Installed dependencies
  - Generated boilerplate files
```

### Shared Worktree State

**Track worktree metadata in DynamoDB:**
```typescript
interface WorktreeRecord {
  PK: 'USER#aaron@company.com',
  SK: 'WORKTREE#PROJ-123',
  
  ticketId: 'PROJ-123',
  worktreePath: '~/repos/myapp-PROJ-123',
  branch: 'feature/PROJ-123',
  status: 'active', // 'active' | 'completed' | 'abandoned'
  
  createdAt: '2025-11-21T09:00:00Z',
  lastAccessedAt: '2025-11-21T14:30:00Z',
  
  artifacts: [
    { type: 'spec', path: '.jira/spec.md', uploaded: true },
    { type: 'implementation', path: 'src/auth/', uploaded: false },
  ],
  
  commits: 3,
  linesChanged: 245,
}
```

**Benefits:**
- Track worktrees across machines (if using cloud storage)
- Know which tickets developer is actively working on
- Analytics on work patterns
- Dashboard can show "Active Worktrees" section

---

## Benefits Summary

### For Developers

**Time Savings:**
- No more `git stash` / `git stash pop`: ~5 min/day
- No branch confusion / wrong commits: ~10 min/week
- Instant context switching: ~15 min/day
- **Total: ~2 hours/week per developer**

**Cognitive Load Reduction:**
- Physical separation = mental clarity
- One folder = one ticket = one feature branch
- Can't accidentally mix work

**Quality Improvements:**
- Fewer merge conflicts (work is isolated)
- Fewer wrong-branch commits
- Better organization of work artifacts

### For Teams

**Visibility:**
- Dashboard shows all active worktrees per developer
- Know who's working on what
- Identify stale/abandoned work

**Standardization:**
- Consistent directory structure
- .jira/ directory convention
- Predictable file locations for skills

**Knowledge Sharing:**
- Templates for common patterns
- Shared skill configurations
- Documented workflows

---

## Migration Guide

### Existing Repos

**For developers already using the repo without worktrees:**

```bash
# 1. Current state: working on feature/PROJ-123 in main repo
$ pwd
~/repos/myapp
$ git branch
* feature/PROJ-123

# 2. Convert to worktree
$ devflow migrate PROJ-123

Actions:
1. Stash any uncommitted changes
2. Switch main repo to 'main' branch
3. Create worktree from existing branch
4. Move .jira/ exports to worktree
5. Restore stashed changes

Migrated PROJ-123 to worktree:
  ~/repos/myapp-PROJ-123/

# 3. Continue working in new location
$ cd ~/repos/myapp-PROJ-123
```

---

## Troubleshooting

### Common Issues

**"Worktree already exists"**
```bash
$ devflow start PROJ-123
Error: Worktree already exists at ~/repos/myapp-PROJ-123

# Solutions:
# 1. Resume work in existing worktree
$ cd ~/repos/myapp-PROJ-123

# 2. Or remove and recreate
$ devflow finish PROJ-123
$ devflow start PROJ-123
```

**"Branch already exists"**
```bash
Error: Branch feature/PROJ-123 already exists

# Solution: Use existing branch
$ devflow start PROJ-123 --use-existing-branch
```

**"Locked by another process"**
```bash
Error: .git/worktrees/myapp-PROJ-123/index.lock exists

# Solution: Remove stale lock
$ rm .git/worktrees/myapp-PROJ-123/index.lock
$ devflow start PROJ-123
```

---

## Best Practices

### DO:
- ✅ One worktree per JIRA ticket
- ✅ Use `.jira/` directory for all JIRA-related files
- ✅ Regularly clean up merged worktrees
- ✅ Use descriptive branch names (feature/PROJ-123)
- ✅ Keep worktrees in consistent location (~/repos/)

### DON'T:
- ❌ Commit `.jira/` directory to git
- ❌ Keep worktrees forever (clean up after merge)
- ❌ Use worktrees for tiny changes (overkill)
- ❌ Create worktrees manually (use CLI tool)
- ❌ Forget to sync JIRA status when switching

---

## Performance Considerations

### Disk Space

Each worktree adds:
- ~5-50 MB for working files (depends on repo)
- ~1-5 MB for .jira/ exports
- Shared .git/ history (no duplication)

**Example for 10 active worktrees:**
```
Main repo: 100 MB
Worktree 1-10: 10 × 25 MB = 250 MB
Total: 350 MB

vs. 10 separate clones: 10 × 100 MB = 1 GB
Savings: 650 MB
```

### Memory

Worktrees share git objects = more efficient than separate clones

### Build Speed

If using incremental builds:
- Each worktree builds independently
- Can work on PROJ-123 while PROJ-124 is building

---

## Future Enhancements

### Potential Features

**1. Cloud Sync**
- Sync .jira/ directory via S3
- Resume work on different machine
- Team members can see each other's specs

**2. AI-Powered Worktree Suggestions**
```bash
$ devflow suggest

Based on your skills and current sprint:
  - PROJ-123 (High priority, matches your expertise)
  - PROJ-125 (Blocked on PROJ-123, good next task)

Start work on PROJ-123? [Y/n]
```

**3. Worktree Analytics**
```bash
$ devflow stats

Your Worktree Usage:
  - Average time per worktree: 4.2 days
  - Average commits per ticket: 5.3
  - Fastest completion: PROJ-120 (6 hours)
  - Most switches: PROJ-118 (15 times)
```

**4. Team Collaboration**
```bash
# See what teammates are working on
$ devflow team

Team Worktrees:
  aaron@company.com:
    - PROJ-123 (In Progress, updated 5 min ago)
    - PROJ-124 (Blocked, waiting on design)
  
  jane@company.com:
    - PROJ-126 (In Review, PR #234)
```

---

## Summary

Git worktrees are a **perfect fit** for the APDevFlow workflow:

- **Physical isolation** prevents mistakes
- **Instant switching** saves time
- **Organized artifacts** (.jira/ directory)
- **Scales to many tickets** without overhead
- **Works great with Claude skills**

**ROI:**
- Setup time: ~2 hours (implement CLI commands)
- Time saved: ~2 hours/week per developer
- Break-even: 1 week
- Ongoing value: Massive

**Recommendation:** Implement worktree support in **Phase 2 or 3** of MVP, after core export/upload functionality is solid.

---

**Ready to implement?** Start with `devflow start` command and build from there!
